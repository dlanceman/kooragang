---
title: "patch_metrics"
author: "Dana Lanceman"
date: "12/8/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:/Users/danal/OneDrive - UNSW/Desktop/WRL/R')
```

```{r get packages}
library(tidyverse)
library(raster)
library(sf)
library(landscapemetrics)

# note that landscapemetrics requires a lot of memory and may come up with an "rcpp" package error if the hardware is not sufficient. Try with a computer with more memory in that case! 

# I've run this and output the patch metrics as two csvs - see chunk 10. Can just skip to this chunk to save time or if insufficient memory. 
```


```{r load data - just 0.1 resolution}
zero1 <- raster("raw/0mos_classified_0_1_all.tif")
nine1 <- raster("raw/9mos_classified_01_all_new.tif")
eighteen1 <- raster("raw/18mos_classified_01_all.tif")
twentysix1 <- raster("raw/26mos_classified_01_all.tif")
thirtyfour1 <- raster("raw/34mos_classified_01_all.tif")
fortytwo1 <- raster("raw/42mos_classified_01_all.tif")
fortysix1 <- raster("raw/46mos_classified_01_all.tif")

# get shapefile and convert to same coordinate system
# need to replace the #'s with a real file name
boundary <- st_read('raw/Clip_work.shp')
boundary <- st_transform(boundary, CRS(proj4string(zero1)))
```

```{r visualise data}
plot(zero1)
plot(nine1)
plot(eighteen1)
plot(twentysix1) # background is labelled # 5 - need to remove
plot(thirtyfour1)
plot(fortytwo1)
plot(fortysix1) # background is labelled # 5 - need to remove

plot(boundary)
```

```{r crop out background for 26 mos and 46 mos}
# crop 26 mos
twsix1.crop <- crop(twentysix1, extent(boundary)) 
twsix1.crop <- mask(twsix1.crop, boundary)
plot(twsix1.crop)

# crop 46 mos
fosix1.crop <- crop(fortysix1, extent(boundary)) 
fosix1.crop <- mask(fosix1.crop, boundary)
plot(fosix1.crop)
```

```{r reassign sarc_clumps as sarc in 9 mos}
# reclassify class 8 as class 2

# create 2 column reclassification matrix for integer data
matrix.data <- c(0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,2)
matrix <- matrix(matrix.data, nrow = 9, ncol = 2, byrow = TRUE)
matrix

# use matrix for reclassifications
nine1 <- reclassify(nine1, matrix)

# visualise
plot(nine1)
```


Landscape metrics package
- article explaining: https://onlinelibrary.wiley.com/doi/full/10.1111/ecog.04617
- documentation: https://cran.r-project.org/web/packages/landscapemetrics/landscapemetrics.pdf
```{r check data are suitable for landscapemetrics}
check_landscape(zero1)
check_landscape(nine1)
check_landscape(eighteen1)
check_landscape(twsix1.crop)
check_landscape(thirtyfour1)
check_landscape(fortytwo1)
check_landscape(fosix1.crop)
# all ok
```


```{r prepare for metric calculation}
possible_metrics <- list_lsm() # list of all possible metrics
#view(possible_metrics)

# make a list of rasters
raster_names <- list(zero1, nine1, eighteen1, twsix1.crop, thirtyfour1, fortytwo1, fosix1.crop)

# make a function to add dataset names and categsories to data
add.metadata <- function(x){
  x %>% mutate(
  dataset = case_when(id == 1 ~ "zero",
                                id == 2 ~ "nine",
                                id == 3 ~ "eighteen",
                                id == 4 ~ "twentysix",
                                id == 5 ~ "thirtyfour",
                                id == 6 ~ "fortytwo",
                                id == 7 ~ "fortysix"),
  category = c("na", "spor","sarc", "grass", "mud", "water", "white_vege","road", 
               "na", "spor", "sarc", "grass", "mud", "water", "white_vege","road", 
               "na", "spor","sarc", "grass", "mud", "water","sueda","road",  "white_vege",
               "spor","sarc", "grass", "mud", "water","sueda", "road","white_vege",
               "na", "spor","sarc","grass", "mud", "water","sueda","road", "white_vege",
               "na", "spor","sarc","grass", "mud", "water","algae","road", "white_vege", "sueda",
               "spor","sarc","grass", "mud", "water","sueda","road", "white_vege")) %>% 
  filter(category != "na") # remove na data
}
# no na for 26 mos / 46 mos due to cropping


# function for adding metadata for landscape metrics
add.meta.land <- function(x){
  x %>% mutate(
  dataset = case_when(id == 1 ~ "zero",
                                id == 2 ~ "nine",
                                id == 3 ~ "eighteen",
                                id == 4 ~ "twentysix",
                                id == 5 ~ "thirtyfour",
                                id == 6 ~ "fortytwo",
                                id == 7 ~ "fortysix"))
}
```

```{r calculate patch metrics}
# apply functions to all datasets at once - note that each takes minutes

# CLASS METRICS
# area and edge metrics
area.means <- lapply(raster_names, lsm_c_area_mn) %>% bind_rows(.id = "id") %>% add.metadata()  # patch area, mean
area.sds <- lapply(raster_names, lsm_c_area_sd) %>% bind_rows(.id = "id") %>% add.metadata() # patch area, sd
area.totals <- lapply(raster_names, lsm_c_ca) %>% bind_rows(.id = "id") %>% add.metadata() # total class area

# core area metrics
cai.mns <- lapply(raster_names, lsm_c_cai_mn) %>% bind_rows(.id = "id") %>% add.metadata() # core area index, mean
cai.sds <- lapply(raster_names, lsm_c_cai_sd) %>% bind_rows(.id = "id") %>% add.metadata() # core area index, sd
core.mns <- lapply(raster_names, lsm_c_core_mn) %>% bind_rows(.id = "id") %>% add.metadata() # alternative core area, mean
core.sds <- lapply(raster_names, lsm_c_core_sd) %>% bind_rows(.id = "id") %>% add.metadata() # alternative core area, sd

# aggregation metrics
nps <- lapply(raster_names, lsm_c_np) %>% bind_rows(.id = "id") %>% add.metadata() # number of patches
cohesions <- lapply(raster_names, lsm_c_cohesion) %>% bind_rows(.id = "id") %>% add.metadata() # cohesion
enn.mns <- lapply(raster_names, lsm_c_enn_mn) %>% bind_rows(.id = "id") %>% add.metadata() # euclidean nearest neighbour distance, mean
enn.sds <- lapply(raster_names, lsm_c_enn_sd) %>% bind_rows(.id = "id") %>% add.metadata() # euclidean nearest neighbour distance, sd
clumpys <- lapply(raster_names, lsm_c_clumpy) %>% bind_rows(.id = "id") %>% add.metadata() # clumpiness

# shape metrics
contig.mns <- lapply(raster_names, lsm_c_contig_mn) %>% bind_rows(.id = "id") %>% add.metadata() # contiguity, mean
contig.sds <- lapply(raster_names, lsm_c_contig_sd) %>% bind_rows(.id = "id") %>% add.metadata() # contiguity, sd
shape.mns <- lapply(raster_names, lsm_c_shape_mn) %>% bind_rows(.id = "id") %>% add.metadata() # shape index, mean
shape.sds <- lapply(raster_names, lsm_c_shape_sd) %>% bind_rows(.id = "id") %>% add.metadata() # shape index, sd


# need to put landscape metrics in a diff table- not compatible - so recode

# LANDSCAPE METRICS
# aggregation metrics
contags <- lapply(raster_names, lsm_l_contag) %>% bind_rows(.id = "id") %>% add.meta.land() # contagion

# diversity metrics
shan.divs <- lapply(raster_names, lsm_l_shdi) %>% bind_rows(.id = "id") %>% add.meta.land() # shannon diversity
shan.evens <- lapply(raster_names, lsm_l_shei) %>% bind_rows(.id = "id") %>% add.meta.land() # shannon evenness 






# combine outputs   
allpatchc <- rbind(area.means, area.sds, area.totals, core.mns, core.sds, cai.mns, cai.sds, nps, cohesions, enn.mns, enn.sds, clumpys, contig.mns, contig.sds, shape.mns, shape.sds) # bind all class metric outputs into one tibble

allpatchl <- rbind(contags, shan.divs, shan.evens)

# then change to wide format with each patch metric as its own column
# add numerical column for dataset (months since restoration)
allpatch.w <- allpatchc %>% dplyr::select(metric, value, dataset, category) %>% pivot_wider(names_from = metric, values_from = value) %>% 
  mutate(months = case_when(dataset == "zero" ~ 0,
                            dataset == "nine" ~ 9,
                            dataset == "eighteen" ~ 21,
                            dataset == "twentysix" ~ 26,
                            dataset == "thirtyfour" ~ 34,
                            dataset == "fortytwo" ~ 42,
                            dataset == "fortysix" ~ 46))

allpatchl.w <- allpatchl %>% dplyr::select(metric, value, dataset) %>% pivot_wider(names_from = metric, values_from = value) %>% 
  mutate(months = case_when(dataset == "zero" ~ 0,
                            dataset == "nine" ~ 9,
                            dataset == "eighteen" ~ 21,
                            dataset == "twentysix" ~ 26,
                            dataset == "thirtyfour" ~ 34,
                            dataset == "fortytwo" ~ 42,
                            dataset == "fortysix" ~ 46))
```


```{r import patch metrics data}
# generated from above script. Just because it takes so long to generate and doesn't work on computers with insufficient memory

allpatch.w <- read.csv("export/csv/classmetrics.csv")
allpatchl.w <- read.csv("export/csv/landmetrics.csv")
```


probably just visualise saltmarsh classes! could have made an overall saltmarsh class first... but didn't. can consider later if we really want it and want this to run for another 3 1/2 hours


```{r visualise trends over time}
# mean patch area
ggplot(allpatch.w, aes(x = months, y = area_mn, color = category)) +
  geom_line()

# mean class area
ggplot(allpatch.w, aes(x = months, y = ca, color = category)) +
  geom_line()

# mean core area
ggplot(allpatch.w, aes(x = months, y = core_mn, color = category)) +
  geom_line()

# core area index (cai)
ggplot(allpatch.w, aes(x = months, y = cai_mn, color = category)) +
  geom_line()

# number of patches
ggplot(allpatch.w, aes(x = months, y = np, color = category)) +
  geom_line()

# cohesion
ggplot(allpatch.w, aes(x = months, y = cohesion, color = category)) +
  geom_line()

# euclidean nearest neighbour average distance between patches
ggplot(allpatch.w, aes(x = months, y = enn_mn, color = category)) +
  geom_line()

# clumpiness
ggplot(allpatch.w, aes(x = months, y = clumpy, color = category)) +
  geom_line()

s# contiguity
ggplot(allpatch.w, aes(x = months, y = contig_mn, color = category)) +
  geom_line()

# mean shape index
ggplot(allpatch.w, aes(x = months, y = shape_mn, color = category)) +
  geom_line()



# landscape metrics

# contagions
ggplot(allpatchl.w, aes(x = months, y = contag)) +
  geom_line()

# shannon diversitys
ggplot(allpatchl.w, aes(x = months, y = shdi)) +
  geom_line()

# shannon evenness
ggplot(allpatchl.w, aes(x = months, y = shei)) +
  geom_line()
```





could then try regressions etc 
```{r}
```

