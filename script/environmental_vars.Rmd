---
title: "Environmental variables"
author: "Dana Lanceman"
date: "12/9/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Prepare data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:/Users/danal/OneDrive - UNSW/Desktop/WRL/R')
```

```{r get packages}
library(tidyverse)
library(raster)
library(sf)
library(padr)
library(Kendall)
library(lubridate)
library(ggpubr)
library(rstatix)
```

```{r get environmental data}
dem <- raster("raw/20170213 kooragang island rgb_dsm.tif")

rain <- read_csv("raw/climate/rainfall_061031.csv") %>% 
  rename("rainfall" = "Rainfall amount (millimetres)") %>% 
  filter(Quality == "Y", # only retain quality assured data
         Year >= 2017) %>% 
  mutate(date = make_date(Year, Month, Day)) %>% 
  select("date", "rainfall")

temp <- read_csv("raw/climate/temperature_061055.csv") %>% 
  rename("temperature" = "Maximum temperature (Degree C)") %>% 
  filter(Quality == "Y", # only retain quality assured data
         Year >= 2017) %>% 
  mutate(date = make_date(Year, Month, Day)) %>% 
  select("date", "temperature")

sea_lev <- read_csv("raw/climate/sealevel_newcastle_60310.csv") %>% 
  filter(Gaps == 0,
         Year >= 2017) %>% 
  mutate(date = make_date(Year, Mth)) %>% 
  select("date", "Minimum", "Maximum", "Mean", "St Devn")
```


```{r get maps}
# cropped maps
zero1 <- raster("raw/0mos_classified_0_1_all.tif")
nine1 <- raster("raw/9mos_classified_01_all_new.tif")
eighteen1 <- raster("raw/18mos_classified_01_all.tif")
twentysix1 <- raster("raw/26mos_classified_01_all.tif")
thirtyfour1 <- raster("raw/34mos_classified_01_all.tif")
fortytwo1 <- raster("raw/42mos_classified_01_all.tif")
fortysix1 <- raster("raw/46mos_classified_01_all.tif")

# boundary for clipping 
boundary <- st_read('raw/Clip_work.shp')
boundary <- st_transform(boundary, CRS(proj4string(zero1)))
```


```{r prepare data}
# for 9 months, reclassify class 8 (sarc clumps) as class 2 (sarc)

# create 2 column reclassification matrix for integer data
matrix.data <- c(0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,2)
matrix <- matrix(matrix.data, nrow = 9, ncol = 2, byrow = TRUE)
matrix

# use matrix for reclassifications
nine1 <- reclassify(nine1, matrix)



# clip all rasters to same extent
zero1c <- crop(zero1, extent(boundary)) 
zero1c <- mask(zero1c, boundary)

nine1c <- crop(nine1, extent(boundary)) 
nine1c <- mask(nine1c, boundary)

eighteen1c <- crop(eighteen1, extent(boundary)) 
eighteen1c <- mask(eighteen1c, boundary)

twentysix1c <- crop(twentysix1, extent(boundary)) 
twentysix1c <- mask(twentysix1c, boundary)

thirtyfour1c <- crop(thirtyfour1, extent(boundary)) 
thirtyfour1c <- mask(thirtyfour1c, boundary)

fortytwo1c <- crop(fortytwo1, extent(boundary)) 
fortytwo1c <- mask(fortytwo1c, boundary)

fortysix1c <- crop(fortysix1, extent(boundary)) 
fortysix1c <- mask(fortysix1c, boundary)

demc <- crop(dem, extent(boundary)) 
demc <- mask(demc, boundary)



# resample dem to same (coarser) resolution as classified images
# also resample all datasets to nine1c as they are all slightly different 
dem_res <- raster::resample(demc, nine1c, method = "bilinear")
zero_res <- raster::resample(zero1c, nine1c, method = "ngb")
eighteen_res <- raster::resample(eighteen1c, nine1c, method = "ngb")
twentysix_res <- raster::resample(twentysix1c, nine1c, method = "ngb")
thirtyfour_res <- raster::resample(thirtyfour1c, nine1c, method = "ngb")
fortytwo_res <- raster::resample(fortytwo1c, nine1c, method = "ngb")
fortysix_res <- raster::resample(fortysix1c, nine1c, method = "ngb")


# create list of datasets
raster_names2 <- list(zero_res, nine1c, eighteen_res, twentysix_res, thirtyfour_res, fortytwo_res, fortysix_res)
```


```{r visualise}
plot(dem_res)

plot(zero_res)
plot(nine1c)
plot(eighteen_res)
plot(twentysix_res)
plot(thirtyfour_res)
plot(fortytwo_res)
plot(fortysix_res)
```

# Elevation - calculations / data manipulation

```{r calculate zonal stats}
zonal_stats <- function(dataset, name){
  zmean <- zonal(dem_res, dataset, fun = "mean", digits = 2)
  zsd <- zonal(dem_res, dataset, fun = "sd", digits = 2)
  zmin <- zonal(dem_res, dataset, fun = "min", digits = 2)
  zmax <- zonal(dem_res, dataset, fun = "max", digits = 2)
  zcount <- zonal(dem_res, dataset, fun = "count", digits = 2, na.rm = TRUE)
  name <- rbind(zmean, zsd, zmin, zmax)
}

 zonal(dem_res, zero_res, fun = "mean", digits = 2)
 
 zonal_stats(zero1c, zero_zonal)


 
 
 

zonal_mean <- function(dataset){
  zonal(dem_res, dataset, fun = "mean", digits = 2)
}


 
means <- lapply(raster_names2,  zonal_mean) %>% bind_rows(.id = "id")
```


count is irrelevant - remove

```{r zero months}
zero_mean <- zonal(dem_res, zero_res, fun = "mean", digits = 2)
zero_sd <- zonal(dem_res, zero_res, fun = "sd", digits = 2)
zero_min <- zonal(dem_res, zero_res, fun = "min", digits = 2)
zero_max <- zonal(dem_res, zero_res, fun = "max", digits = 2)
zero_count <- zonal(dem_res, zero_res, fun = "count", digits = 2)

zero_demstats <- combine(zero_mean, zero_sd, zero_min, zero_max, zero_count) %>% 
  mutate(dataset = 0)
zero_demstats$source <-  recode(zero_demstats$source, 
         "zero_mean" = "mean",
         "zero_sd" = "sd",
         "zero_min" = "min",
         "zero_max" = "max",
         "zero_count" = "count") 
zero_demstats$category <- c("na", "spor","sarc", "grass", "mud", "water", "white_vege","road")
```

```{r nine months}
nine_mean <- zonal(dem_res, nine1c, fun = "mean", digits = 2)
nine_sd <- zonal(dem_res, nine1c, fun = "sd", digits = 2)
nine_min <- zonal(dem_res, nine1c, fun = "min", digits = 2)
nine_max <- zonal(dem_res, nine1c, fun = "max", digits = 2)
nine_count <- zonal(dem_res, nine1c, fun = "count", digits = 2)

nine_demstats <- combine(nine_mean, nine_sd, nine_min, nine_max, nine_count) %>% 
  mutate(dataset = 9)
nine_demstats$source <-  recode(nine_demstats$source, 
         "nine_mean" = "mean",
         "nine_sd" = "sd",
         "nine_min" = "min",
         "nine_max" = "max",
         "nine_count" = "count") 
nine_demstats$category <- c("na", "spor", "sarc",  "grass", "mud", "water", "white_vege", "road") # add categories
```

```{r eighteen months}
eighteen_mean <- zonal(dem_res, eighteen_res, fun = "mean", digits = 2)
eighteen_sd <- zonal(dem_res, eighteen_res, fun = "sd", digits = 2)
eighteen_min <- zonal(dem_res, eighteen_res, fun = "min", digits = 2)
eighteen_max <- zonal(dem_res, eighteen_res, fun = "max", digits = 2)
eighteen_count <- zonal(dem_res, eighteen_res, fun = "count", digits = 2)

eighteen_demstats <- combine(eighteen_mean, eighteen_sd, eighteen_min, eighteen_max, eighteen_count) %>% 
  mutate(dataset = 18)
eighteen_demstats$source <-  recode(eighteen_demstats$source, 
         "eighteen_mean" = "mean",
         "eighteen_sd" = "sd",
         "eighteen_min" = "min",
         "eighteen_max" = "max",
         "eighteen_count" = "count")
eighteen_demstats$category <- c("na", "spor","sarc", "grass", "mud", "water","sueda","road",  "white_vege") # add categories
```

```{r twenty six months}
twentysix_mean <- zonal(dem_res, twentysix_res, fun = "mean", digits = 2)
twentysix_sd <- zonal(dem_res, twentysix_res, fun = "sd", digits = 2)
twentysix_min <- zonal(dem_res, twentysix_res, fun = "min", digits = 2)
twentysix_max <- zonal(dem_res, twentysix_res, fun = "max", digits = 2)
twentysix_count <- zonal(dem_res, twentysix_res, fun = "count", digits = 2)

twentysix_demstats <- combine(twentysix_mean, twentysix_sd, twentysix_min, twentysix_max, twentysix_count) %>% 
  mutate(dataset = 26)
twentysix_demstats$source <-  recode(twentysix_demstats$source, 
         "twentysix_mean" = "mean",
         "twentysix_sd" = "sd",
         "twentysix_min" = "min",
         "twentysix_max" = "max",
         "twentysix_count" = "count") 
twentysix_demstats$category <- c("spor","sarc", "grass", "mud", "water","sueda", "road", "white_vege") # add categories
```

```{r thirty four months}
thirtyfour_mean <- zonal(dem_res, thirtyfour_res, fun = "mean", digits = 2)
thirtyfour_sd <- zonal(dem_res, thirtyfour_res, fun = "sd", digits = 2)
thirtyfour_min <- zonal(dem_res, thirtyfour_res, fun = "min", digits = 2)
thirtyfour_max <- zonal(dem_res, thirtyfour_res, fun = "max", digits = 2)
thirtyfour_count <- zonal(dem_res, thirtyfour_res, fun = "count", digits = 2)

thirtyfour_demstats <- combine(thirtyfour_mean, thirtyfour_sd, thirtyfour_min, thirtyfour_max, thirtyfour_count) %>% 
  mutate(dataset = 34)
thirtyfour_demstats$source <-  recode(thirtyfour_demstats$source, 
         "thirtyfour_mean" = "mean",
         "thirtyfour_sd" = "sd",
         "thirtyfour_min" = "min",
         "thirtyfour_max" = "max",
         "thirtyfour_count" = "count") 
thirtyfour_demstats$category <- c("spor","sarc","grass", "mud", "water","sueda","road", "white_vege") # add categories
```

```{r forty two months}
fortytwo_mean <- zonal(dem_res, fortytwo_res, fun = "mean", digits = 2)
fortytwo_sd <- zonal(dem_res, fortytwo_res, fun = "sd", digits = 2)
fortytwo_min <- zonal(dem_res, fortytwo_res, fun = "min", digits = 2)
fortytwo_max <- zonal(dem_res, fortytwo_res, fun = "max", digits = 2)
fortytwo_count <- zonal(dem_res, fortytwo_res, fun = "count", digits = 2)

fortytwo_demstats <- combine(fortytwo_mean, fortytwo_sd, fortytwo_min, fortytwo_max, fortytwo_count) %>% 
  mutate(dataset = 42)
fortytwo_demstats$source <-  recode(fortytwo_demstats$source, 
         "fortytwo_mean" = "mean",
         "fortytwo_sd" = "sd",
         "fortytwo_min" = "min",
         "fortytwo_max" = "max",
         "fortytwo_count" = "count") 
fortytwo_demstats$category <- c("na", "spor","sarc","grass", "mud", "water","algae","road", "white_vege", "sueda") # add categories
```

```{r forty six months}
fortysix_mean <- zonal(dem_res, fortysix_res, fun = "mean", digits = 2)
fortysix_sd <- zonal(dem_res, fortysix_res, fun = "sd", digits = 2)
fortysix_min <- zonal(dem_res, fortysix_res, fun = "min", digits = 2)
fortysix_max <- zonal(dem_res, fortysix_res, fun = "max", digits = 2)
fortysix_count <- zonal(dem_res, fortysix_res, fun = "count", digits = 2)

fortysix_demstats <- combine(fortysix_mean, fortysix_sd, fortysix_min, fortysix_max, fortysix_count) %>% 
  mutate(dataset = 46)
fortysix_demstats$source <-  recode(fortysix_demstats$source, 
         "fortysix_mean" = "mean",
         "fortysix_sd" = "sd",
         "fortysix_min" = "min",
         "fortysix_max" = "max",
         "fortysix_count" = "count") 
fortysix_demstats$category <- c("spor","sarc","grass", "mud", "water","sueda","road", "white_vege") # add categories
```

```{r combine}
allzonal <- rbind(zero_demstats, nine_demstats, eighteen_demstats, twentysix_demstats, thirtyfour_demstats, fortytwo_demstats, fortysix_demstats) %>% 
  filter(category %in% c("spor", "sarc", "sueda"))
```

```{r make into wide format, add SE column}
allzonal_wide <- allzonal %>% dplyr::select(mean, source, dataset, category) %>%
  pivot_wider(names_from = source, values_from = mean)

allzonal_wide <- allzonal_wide %>% mutate(se = sd/sqrt(count))
```

```{r add date column}
allzonal_wide <- allzonal_wide %>% mutate(date = case_when(
         dataset == 0 ~ "2017/02/03",
         dataset == 9 ~ "2017/10/19",
         dataset == 18 ~ "2018/11/09",
         dataset == 26 ~ "2019/04/30",
         dataset == 34 ~ "2019/12/18",
         dataset == 42 ~ "2020/08/13",
         dataset == 46 ~ "2020/12/08")) 
allzonal_wide$date <- as.Date(allzonal_wide$date)
```


# Elevation - plot

does the elevation that different saltmarsh grows at differ between species and over time?

```{r plot function}
plot_elev <- function(variable){
  ggplot(allzonal_wide) +
  aes(x = date, y = variable, color = category, linetype = category) +
  geom_line(size = 3) +
    scale_color_manual(values = c("#1fbfad", "#f2c80c", "#5c0b1f"), labels = c("Sarcocornia","Sporobolus","Suaeda")) +
    scale_linetype_manual(values=c(2,3,4), labels = c("Sarcocornia","Sporobolus","Suaeda")) +
    labs(x = "Date", y = "Mean elevation (m)", color = "Category", linetype = "Category") +
  theme_classic() +
  guides(color = guide_legend(byrow = TRUE)) + # for legend spacing 
  theme(axis.text = element_text(size = 40),
        axis.title = element_text(size = 54),
        legend.text = element_text(size = 30),
        legend.title = element_text(size = 36),
        plot.margin = margin(20,20,10,10),
        legend.spacing.y = unit(1, "cm"),
        legend.key.size = unit(3,"line"),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)))
}
```


```{r plot mean elevation}
plot_elev(allzonal_wide$mean)
```

max and min are unhelpful, show some extreme outliers that have incorrect DEM values (i.e. both negative values and values > 2 m are incorrect for this wetland)

# Elevation Trend analysis 
Did mean elevation change over time for each species?

```{r pad time series}
allzonal.spor <- allzonal_wide %>% filter(category == "spor") %>% pad()
allzonal.sarc <- allzonal_wide %>% filter(category == "sarc") %>% pad() # sig
allzonal.sueda <- allzonal_wide %>% filter(category == "sueda") %>% pad()
```

```{r Kendall rank correlations}
MannKendall(ts(allzonal.spor$mean,frequency = 365, start = c(2017,34)))
MannKendall(ts(allzonal.sarc$mean,frequency = 365, start = c(2017,34)))
MannKendall(ts(allzonal.sueda$mean,frequency = 365, start = c(2018,313)))

```


also consider clipping e.g. final image by each saltmarsh class, and then mapping frequency distribution at different elevations



# Rainfall, temperature and sea level 

```{r visualise trends in each variable over time}
ggplot(sea_lev, aes(date, Mean)) + geom_line()
ggplot(sea_lev, aes(date, Maximum)) + geom_line()
ggplot(sea_lev, aes(date, Minimum)) + geom_line()

ggplot(temp, aes(date, temperature)) + geom_line()

ggplot(rain, aes(date, rainfall)) + geom_line()
```

```{r combine environmental variables into a single dataframe}
env <- full_join(sea_lev, temp, by = "date")
env <- full_join(env, rain, by = "date") %>% 
  rename("min_sealev" = "Minimum",
         "max_sealev" = "Maximum",
         "mean_sealev" = "Mean",
         "sd_sealev" = "St Devn")
```


```{r visualise relationships between variables}
ggplot(env, aes(max_sealev, mean_sealev)) + geom_point()
ggplot(env, aes(mean_sealev, min_sealev)) + geom_point()
ggplot(env, aes(max_sealev, min_sealev)) + geom_point()
# sea level variables are correlated, but not super strongly

cor.test(env$max_sealev, env$mean_sealev) # cor = 0.4996957
cor.test(env$min_sealev, env$mean_sealev) # cor = 0.7196871
cor.test(env$min_sealev, env$max_sealev) # cor = 0.4312195

# definitely can't use max and mean sea level together, not sure about others. not sure how relevant any sea level variables are, given the artificial tidal inundation

ggplot(env, aes(max_sealev, rainfall)) + geom_point() # certainly no correlation
ggplot(env, aes(max_sealev, temperature)) + geom_point() # no correlation

ggplot(env, aes(min_sealev, rainfall)) + geom_point() # certainly no correlation
ggplot(env, aes(min_sealev, temperature)) + geom_point() # no correlation


ggplot(env, aes(mean_sealev, rainfall)) + geom_point() # certainly no correlation
ggplot(env, aes(mean_sealev, temperature)) + geom_point() # perhaps some correlation

cor.test(env$temperature, env$mean_sealev) # cor = -0.17... all good

ggplot(env, aes(temperature, rainfall))+ geom_point() # no correlation

# therefore try a model with min sea level, max sea level, rainfall and temperature
```

for how long before the drone imagery was taken is each variable relevant?
- entire period after previous drone image?
- fixed period - how long?

```{r summarise environmental variables between drone images}
env <- env %>% 
  mutate(fullperiod = case_when(
  date >= "2017-02-03" & date < "2017-10-19" ~ "one",
  date >= "2017-10-19" & date < "2018-11-09" ~ "two",
  date >= "2018-11-09" & date < "2019-04-30" ~ "three",
  date >= "2019-04-30" & date < "2019-12-18" ~ "four",
  date >= "2019-12-18" & date < "2020-08-13" ~ "five",
  date >= "2020-08-13" & date < "2020-12-08" ~ "six"
),
  prevmonth = case_when(
  date >= "2017-09-19" & date < "2017-10-19" ~ "one",
  date >= "2018-10-09" & date < "2018-11-09" ~ "two",
  date >= "2019-03-30" & date < "2019-04-30" ~ "three",
  date >= "2019-11-18" & date < "2019-12-18" ~ "four",
  date >= "2020-07-13" & date < "2020-08-13" ~ "five",
  date >= "2020-11-08" & date < "2020-12-08" ~ "six"
),
  threemonth = case_when(
  date >= "2017-07-19" & date < "2017-10-19" ~ "one",
  date >= "2018-08-09" & date < "2018-11-09" ~ "two",
  date >= "2019-01-30" & date < "2019-04-30" ~ "three",
  date >= "2019-09-18" & date < "2019-12-18" ~ "four",
  date >= "2020-05-13" & date < "2020-08-13" ~ "five",
  date >= "2020-09-08" & date < "2020-12-08" ~ "six"
),
 sixmonth = case_when(
  date >= "2017-04-19" & date < "2017-10-19" ~ "one",
  date >= "2018-05-09" & date < "2018-11-09" ~ "two",
  date >= "2018-10-30" & date < "2019-04-30" ~ "three",
  date >= "2019-06-18" & date < "2019-12-18" ~ "four",
  date >= "2020-02-13" & date < "2020-08-13" ~ "five",
  date >= "2020-06-08" & date < "2020-12-08" ~ "six")) %>% 
  filter(!is.na(fullperiod))

env_fullperiod <- env %>% 
  group_by(fullperiod) %>% 
  summarise(max_sl_mn = mean(max_sealev, na.rm = TRUE),
            min_sl_mn = mean(min_sealev, na.rm = TRUE),
            mean_sl_mn = mean(mean_sealev, na.rm = TRUE),
            sd_sl_mn = mean(sd_sealev, na.rm = TRUE),
            rain_tot = sum(rainfall, na.rm = TRUE),
            temp_mn = mean(temperature, na.rm = TRUE)) %>% 
  rename(dataset = fullperiod)

env_prevmonth <- env %>% 
  group_by(prevmonth) %>% 
  summarise(max_sl_mn = mean(max_sealev, na.rm = TRUE),
            min_sl_mn = mean(min_sealev, na.rm = TRUE),
            mean_sl_mn = mean(mean_sealev, na.rm = TRUE),
            sd_sl_mn = mean(sd_sealev, na.rm = TRUE),
            rain_tot = sum(rainfall, na.rm = TRUE),
            temp_mn = mean(temperature, na.rm = TRUE)) %>% 
  filter(!is.na(prevmonth)) %>% 
  rename(dataset = prevmonth) 

env_threemonth <- env %>% 
  group_by(threemonth) %>% 
  summarise(max_sl_mn = mean(max_sealev, na.rm = TRUE),
            min_sl_mn = mean(min_sealev, na.rm = TRUE),
            mean_sl_mn = mean(mean_sealev, na.rm = TRUE),
            sd_sl_mn = mean(sd_sealev, na.rm = TRUE),
            rain_tot = sum(rainfall, na.rm = TRUE),
            temp_mn = mean(temperature, na.rm = TRUE)) %>% 
  filter(!is.na(threemonth)) %>% 
  rename(dataset = threemonth)

env_sixmonth <- env %>% 
  group_by(sixmonth) %>% 
  summarise(max_sl_mn = mean(max_sealev, na.rm = TRUE),
            min_sl_mn = mean(min_sealev, na.rm = TRUE),
            mean_sl_mn = mean(mean_sealev, na.rm = TRUE),
            sd_sl_mn = mean(sd_sealev, na.rm = TRUE),
            rain_tot = sum(rainfall, na.rm = TRUE),
            temp_mn = mean(temperature, na.rm = TRUE)) %>% 
  filter(!is.na(sixmonth)) %>% 
  rename(dataset = sixmonth)
```



regress growth against environmental conditions?

use one_scale, variable made in "class_areas" script

```{r summarise growth between drone images}
one_scale <- one_scale %>% mutate(dataset = case_when(
  date == "2017-02-03" ~ 1,
  date == "2017-10-19" ~ 2,
  date == "2018-11-09" ~ 3,
  date == "2019-04-30" ~ 4,
  date == "2019-12-18" ~ 5,
  date == "2020-08-13" ~ 6,
  date == "2020-12-08" ~ 7
))

growth <- one_scale %>%
  # first sort by category then by dataset
  arrange(category, dataset) %>%
  mutate(Diff_days = as.numeric(date) - lag(as.numeric(date)), # days between datasets
         Diff_area = area - lag(area)) %>% # Difference in area between datasets 
  filter(dataset != 1, # remove entries for first dataset, as these would have been calculated between categories, which is irrelevant
         category %in% c("spor","sueda","sarc","saltmarsh")) %>% 
  mutate(dataset = case_when(
    dataset == 2 ~ "one",
    dataset == 3 ~ "two",
    dataset == 4 ~ "three",
    dataset == 5 ~ "four",
    dataset == 6 ~ "five",
    dataset == 7 ~ "six"
  )) %>% 
  select(category, dataset, Diff_days, Diff_area)
  
growth$Diff_area[19] <- 0.416472 # assuming sueda started with an area of 0, initial growth equals the area of sueda the first time it was measured, i.e. 0.416472
growth$Diff_days[19] <- 644 # number of days from first to third dataset

growth <- growth %>% 
  mutate(growthrate = Diff_area/Diff_days) %>% 
  select(category, dataset, growthrate, Diff_days)

```


```{r combine env and growth datasets}
env_fullperiod <- left_join(growth, env_fullperiod, by = "dataset") %>% 
  mutate(rainrate = rain_tot / Diff_days)
env_prevmonth <- left_join(growth, env_prevmonth, by = "dataset") %>% 
  mutate(rainrate = rain_tot / Diff_days)
env_threemonth <- left_join(growth, env_threemonth, by = "dataset") %>% 
  mutate(rainrate = rain_tot / Diff_days)
env_sixmonth <- left_join(growth, env_sixmonth, by = "dataset") %>% 
  mutate(rainrate = rain_tot / Diff_days)
```

```{r explore relationships}
# full period
ggplot(env_fullperiod, aes(max_sl_mn, growthrate, color = category)) + 
  geom_point() 
ggplot(env_fullperiod, aes(min_sl_mn, growthrate, color = category)) + 
  geom_point() # maybe a trend with spor
ggplot(env_fullperiod, aes(mean_sl_mn, growthrate, color = category)) + 
  geom_point() # maybe a trend with spor
ggplot(env_fullperiod, aes(rainrate, growthrate, color = category)) + 
  geom_point()
ggplot(env_fullperiod, aes(temp_mn, growthrate, color = category)) + 
  geom_point()

# six months
ggplot(env_sixmonth, aes(max_sl_mn, growthrate, color = category)) + 
  geom_point() 
ggplot(env_sixmonth, aes(min_sl_mn, growthrate, color = category)) + 
  geom_point() # maybe a trend with spor
ggplot(env_sixmonth, aes(mean_sl_mn, growthrate, color = category)) + 
  geom_point() # maybe a trend with spor
ggplot(env_sixmonth, aes(rainrate, growthrate, color = category)) + 
  geom_point()
ggplot(env_sixmonth, aes(temp_mn, growthrate, color = category)) + 
  geom_point()

# three months
ggplot(env_threemonth, aes(max_sl_mn, growthrate, color = category)) + 
  geom_point() 
ggplot(env_threemonth, aes(min_sl_mn, growthrate, color = category)) + 
  geom_point() # maybe a trend with spor
ggplot(env_threemonth, aes(mean_sl_mn, growthrate, color = category)) + 
  geom_point() # all have a rough trend
ggplot(env_threemonth, aes(rainrate, growthrate, color = category)) + 
  geom_point()
ggplot(env_threemonth, aes(temp_mn, growthrate, color = category)) + 
  geom_point()

# one month
ggplot(env_prevmonth, aes(max_sl_mn, growthrate, color = category)) + 
  geom_point() 
ggplot(env_prevmonth, aes(min_sl_mn, growthrate, color = category)) + 
  geom_point() 
ggplot(env_prevmonth, aes(mean_sl_mn, growthrate, color = category)) + 
  geom_point() # sueda, sarc and overall saltmarsh have a bit of a trend (mostly sueda)
ggplot(env_prevmonth, aes(rainrate, growthrate, color = category)) + 
  geom_point() # somewhat of a negative trend for spor, sarc and overall saltmarsh
ggplot(env_prevmonth, aes(temp_mn, growthrate, color = category)) + 
  geom_point()
```

Run Multiple regressions - models with multiple predictors - ok that one is categorical (category) and rest are quantitative (sea level, temp, rainfall). 
- Basically equivalent to ANCOVA, but we don't need to emphasise the categorical variable, as in ANCOVA

Assumptions!
1) Independence of data within and among samples - true, the amount saltmarsh has grown between each drone image is not directly related to previous growth periods
2) Marginal relationship between response variable and each predictor is linear
3) Normality of residuals 
4) Homogeneity of variances of residuals
5) No interactions among predictor variables, if you want to interpret main effects


```{r data exploration - cleveland plots}
cleveland_plot <- function(vector,axislab){
  par(mfrow= c(1,2), mar = c(5,4,2,1)) # set some parameters for the plot
  boxplot(vector,  ylab = axislab)
  dotchart(vector, xlab = axislab,
         ylab = "Order of the data") 
}

# full period
cleveland_plot(env_fullperiod$max_sl_mn, "Mean maximum sea level (m)") # great
cleveland_plot(env_fullperiod$min_sl_mn, "Mean minimum sea level (m)") # great
cleveland_plot(env_fullperiod$temp_mn, "Mean temperature (deg C)") # right skewed, transformations don't really help. but no outliers
cleveland_plot(env_fullperiod$rainrate, "Mean daily rainfall (mm)") # good
# however log transforming rainfall improves the diagnostic plots below. Makes the distribution more skewed but ok.
cleveland_plot(log(env_fullperiod$rainrate), "log mean daily rainfall (mm)")
cleveland_plot(env_fullperiod$growthrate, "Growth rate (area per day)") # right skewed
cleveland_plot(log(env_fullperiod$growthrate + 0.01), "log Growth rate (area per day)") # log transformed is better

# transform growth rate and rainfall (to improve diagnostic plots)
env_fullperiod <- env_fullperiod %>% mutate(log_growthrate = log(growthrate + 0.05),
                                            log_rainrate = log(rainrate))


# six months
cleveland_plot(env_sixmonth$max_sl_mn, "Mean maximum sea level (m)") # great
cleveland_plot(env_sixmonth$min_sl_mn, "Mean minimum sea level (m)") # weird gap in middle but fine
cleveland_plot(env_sixmonth$temp_mn, "Mean temperature (deg C)") # right skewed, transformations don't really help. it is an outlier but realistic
cleveland_plot(env_sixmonth$rainrate, "Mean daily rainfall (mm)") # fine
cleveland_plot(env_sixmonth$growthrate, "Growth rate (area per day)") # slightly right skewed
cleveland_plot(log(env_sixmonth$growthrate + 0.01), "log Growth rate (area per day)") # log transformed is better

# transform growth rate
env_sixmonth <- env_sixmonth %>% mutate(log_growthrate = log(growthrate + 0.01))


# three months
cleveland_plot(env_threemonth$max_sl_mn, "Mean maximum sea level (m)") # slight outlier but ok
cleveland_plot(env_threemonth$min_sl_mn, "Mean minimum sea level (m)") # slight outlier but ok
cleveland_plot(env_threemonth$temp_mn, "Mean temperature (deg C)") # left skewed, transformations don't help. somewhat of an outlier but ok
cleveland_plot(env_threemonth$rainrate, "Mean daily rainfall (mm)") # outlier
cleveland_plot(log(env_threemonth$rainrate), "Mean daily rainfall (mm)") # log transform helps
cleveland_plot(env_threemonth$growthrate, "Growth rate (area per day)") # slightly right skewed
cleveland_plot(log(env_threemonth$growthrate + 0.01), "log Growth rate (area per day)") # log transformed is better

# transform growth rate and rainfall
env_threemonth <- env_threemonth %>% mutate(log_growthrate = log(growthrate + 0.01),
                                            log_rainrate = log(rainrate))


# one month
cleveland_plot(env_prevmonth$max_sl_mn, "Mean maximum sea level (m)") # great
cleveland_plot(env_prevmonth$min_sl_mn, "Mean minimum sea level (m)") # weird distribution, because there are only few values that mean min sea level takes and there is a massive gap between. transformations don't help. not considered an outlier though
cleveland_plot(sqrt(env_prevmonth$temp_mn), "Mean temperature (deg C)") # left skewed, transformations don't help. bit of an outlier but ok
cleveland_plot(env_prevmonth$rainrate, "Mean daily rainfall (mm)") # fine
cleveland_plot(env_prevmonth$growthrate, "Growth rate (area per day)") # slightly right skewed
cleveland_plot(log(env_prevmonth$growthrate + 0.01), "log Growth rate (area per day)") # log transformed is better

# transform growth rate
env_prevmonth <- env_prevmonth %>% mutate(log_growthrate = log(growthrate + 0.01))
```



```{r multiple regression models - include category as a predictor}
# we're interested in interactions between category and the continuous predictor variables.

full_model <- lm(log_growthrate ~ (max_sl_mn +  min_sl_mn + temp_mn + log_rainrate) * category, data = env_fullperiod %>% filter(category != "saltmarsh")) 
summary(full_model)


month_model <- lm(log_growthrate ~ (max_sl_mn + min_sl_mn + temp_mn + rainrate) * category, data = env_prevmonth %>% filter(category != "saltmarsh"))
summary(month_model)


threemonth_model <- lm(log_growthrate ~ (max_sl_mn + min_sl_mn + temp_mn + log_rainrate) * category, data = env_threemonth %>% filter(category != "saltmarsh"))
summary(threemonth_model)



sixmonth_model <- lm(log_growthrate ~ (max_sl_mn + min_sl_mn + temp_mn + rainrate) * category, data = env_sixmonth %>% filter(category != "saltmarsh"))
summary(sixmonth_model)
```

Diagnostic plots
- residuals vs fitted - linearity
- normal QQ - normality
- scale-location - equal variances


```{r diagnostic plots}
par(mfrow = c(2, 2))
plot(full_model) # top left equal variances, top right normality 

plot(month_model) # top left equal variances, top right normality 

plot(threemonth_model) # top left equal variances, top right normality 

plot(sixmonth_model) # top left equal variances, top right normality 

par(mfrow = c(1, 1))

# assumptions are acceptable across all plots

# all plots come up with warning messages:
# 1: not plotting observations with leverage one:
 # 13, 14, 15, 16, 17 
# 2: In sqrt(crit * p * (1 - hh)/hh) : NaNs produced
# 3: In sqrt(crit * p * (1 - hh)/hh) : NaNs produced
# if temp is removed, all messages disappear
# if any other continuous predictor is removed, the first error message disappears but the others stay
# if category is removed, all error messages disappear

# i think this is related to the dummy coding of "category" - some values will be assigned as 0 and this might confuse things

# it should be ok to go ahead with these warning messages
```

